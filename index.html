<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0c10" />
  <link rel="manifest" href="manifest.webmanifest" />
  <title>Diesel Boat Sleep Noise</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: #0b0c10; }
    body { margin: 16px; max-width: 1120px; }
    h1 { margin: 0 0 8px; font-size: 20px; }
    .sub { color:#444; font-size: 12.5px; line-height: 1.35; margin-bottom: 12px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card { border:1px solid #ddd; border-radius: 12px; padding: 12px; background: #fff; }
    .row { display:grid; grid-template-columns: 180px 1fr 90px; gap: 10px; align-items:center; margin: 8px 0; }
    label { font-size: 12.5px; color:#111; }
    input[type="range"] { width: 100%; }
    select, input[type="number"], input[type="text"] {
      width:100%; padding: 7px 8px; border:1px solid #ccc; border-radius: 10px; font-size: 13px;
    }
    .actions { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; margin: 10px 0 14px; }
    button {
      padding: 10px 12px; border-radius: 12px; border: 1px solid #bbb; background: #f7f7f7;
      cursor: pointer; font-weight: 650;
    }
    button.primary { background: #0b0c10; color: #fff; border-color:#0b0c10; }
    button:disabled { opacity: 0.55; cursor:not-allowed; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .status { font-size: 13px; color: #111; }
    .warn { color:#8a2a2a; font-size: 12.5px; line-height: 1.35; margin-top: 8px; }
    .small { font-size: 12px; color:#444; line-height: 1.35; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; color:#333; background:#fafafa; }
  </style>
</head>
<body>
  <h1>Diesel Boat Sleep Noise — PWA (Streaming AudioWorklet)</h1>
  <div class="sub">
    Streaming audio is synthesized in real time. Export produces a WAV file in-browser (keep exports shorter on iPhone and loop playback).
    <span class="pill">12 engines</span> <span class="pill">exhaust formants</span> <span class="pill">turbo whine/hiss/flutter</span> <span class="pill">HQ stack ring</span>
  </div>

  <div class="actions">
    <button id="btnStart" class="primary">Start</button>
    <button id="btnStop" disabled>Stop</button>
    <button id="btnExport">Export WAV</button>
    <span id="status" class="status">Idle.</span>
  </div>

  <div class="grid">
    <div class="card">
      <h3 style="margin:0 0 10px;">Engine Model</h3>
      <div class="row">
        <label>Preset engine</label>
        <select id="preset"></select>
        <span></span>
      </div>

      <div class="row">
        <label>High Quality Mode</label>
        <select id="hq">
          <option value="0" selected>Standard (lower CPU)</option>
          <option value="1">HQ (stack ring + extra resonance)</option>
        </select>
        <span></span>
      </div>

      <div class="small">
        Presets define cylinders/firing cadence, exhaust resonance and turbo baseline. “HQ” adds stack ring/comb resonance and extra shaping (more realistic, more CPU).
      </div>

      <h3 style="margin:14px 0 10px;">Output</h3>
      <div class="row"><label>Master Level</label><input id="master" type="range" min="0" max="1" step="0.01" value="0.55"><span id="masterV" class="mono"></span></div>
      <div class="row"><label>Stereo Width</label><input id="stereo" type="range" min="0" max="1" step="0.01" value="0.60"><span id="stereoV" class="mono"></span></div>
      <div class="row"><label>Limiter</label><input id="limiter" type="range" min="0" max="1" step="0.01" value="0.65"><span id="limiterV" class="mono"></span></div>

      <h3 style="margin:14px 0 10px;">Mix Levels</h3>
      <div class="row"><label>Engine Level</label><input id="engine" type="range" min="0" max="1" step="0.01" value="0.25"><span id="engineV" class="mono"></span></div>
      <div class="row"><label>Exhaust Level</label><input id="exhaust" type="range" min="0" max="1" step="0.01" value="0.35"><span id="exhaustV" class="mono"></span></div>
      <div class="row"><label>Turbo Level</label><input id="turbo" type="range" min="0" max="1" step="0.01" value="0.15"><span id="turboV" class="mono"></span></div>
      <div class="row"><label>Waves Level</label><input id="waves" type="range" min="0" max="1" step="0.01" value="0.20"><span id="wavesV" class="mono"></span></div>
      <div class="row"><label>Current Level</label><input id="current" type="range" min="0" max="1" step="0.01" value="0.20"><span id="currentV" class="mono"></span></div>

      <div class="warn">
        iOS: if silent, disable Silent mode and tap Start again (gesture required to unlock audio).
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px;">Tone Customization</h3>

      <div class="row"><label>RPM</label><input id="rpm" type="range" min="300" max="2200" step="10" value="780"><span id="rpmV" class="mono"></span></div>
      <div class="row"><label>Load</label><input id="load" type="range" min="0" max="1" step="0.01" value="0.35"><span id="loadV" class="mono"></span></div>
      <div class="row"><label>Roughness</label><input id="rough" type="range" min="0" max="1" step="0.01" value="0.35"><span id="roughV" class="mono"></span></div>
      <div class="row"><label>Thump</label><input id="thump" type="range" min="0" max="1" step="0.01" value="0.45"><span id="thumpV" class="mono"></span></div>

      <h3 style="margin:14px 0 10px;">Exhaust Note</h3>
      <div class="row"><label>Exhaust Muffling</label><input id="muffle" type="range" min="0" max="1" step="0.01" value="0.55"><span id="muffleV" class="mono"></span></div>
      <div class="row"><label>Formant A (Hz)</label><input id="formA" type="range" min="60" max="650" step="5" value="140"><span id="formAV" class="mono"></span></div>
      <div class="row"><label>Formant B (Hz)</label><input id="formB" type="range" min="150" max="1400" step="10" value="420"><span id="formBV" class="mono"></span></div>
      <div class="row"><label>Formant Q</label><input id="formQ" type="range" min="0.5" max="18" step="0.1" value="7.0"><span id="formQV" class="mono"></span></div>
      <div class="row"><label>Stack Ring Amount</label><input id="ring" type="range" min="0" max="1" step="0.01" value="0.25"><span id="ringV" class="mono"></span></div>
      <div class="row"><label>Stack Ring Pitch</label><input id="ringHz" type="range" min="40" max="220" step="2" value="92"><span id="ringHzV" class="mono"></span></div>

      <h3 style="margin:14px 0 10px;">Turbo</h3>
      <div class="row"><label>Turbo Base Freq</label><input id="turboFreq" type="range" min="200" max="4200" step="10" value="950"><span id="turboFreqV" class="mono"></span></div>
      <div class="row"><label>Spool Mod</label><input id="turboSpool" type="range" min="0" max="1" step="0.01" value="0.15"><span id="turboSpoolV" class="mono"></span></div>
      <div class="row"><label>Turbo Hiss</label><input id="turboHiss" type="range" min="0" max="1" step="0.01" value="0.25"><span id="turboHissV" class="mono"></span></div>
      <div class="row"><label>Compressor Flutter</label><input id="flutter" type="range" min="0" max="1" step="0.01" value="0.10"><span id="flutterV" class="mono"></span></div>

      <h3 style="margin:14px 0 10px;">Water</h3>
      <div class="row"><label>Wave Chop Rate</label><input id="chop" type="range" min="0.01" max="0.35" step="0.01" value="0.07"><span id="chopV" class="mono"></span></div>
      <div class="row"><label>Current Brightness</label><input id="bright" type="range" min="0" max="1" step="0.01" value="0.35"><span id="brightV" class="mono"></span></div>

      <h3 style="margin:14px 0 10px;">Export</h3>
      <div class="row">
        <label>Duration (minutes)</label>
        <input id="minutes" type="number" min="1" max="720" step="1" value="60">
        <span class="mono">min</span>
      </div>
      <div class="row">
        <label>Sample Rate</label>
        <select id="sr">
          <option value="44100" selected>44100 Hz</option>
          <option value="48000">48000 Hz</option>
        </select>
        <span></span>
      </div>
      <div class="row">
        <label>Channels</label>
        <select id="ch">
          <option value="2" selected>Stereo</option>
          <option value="1">Mono</option>
        </select>
        <span></span>
      </div>
      <div class="row">
        <label>File name</label>
        <input id="filename" type="text" value="diesel_boat_sleep.wav">
        <span></span>
      </div>

      <div class="small">
        If export fails on iPhone, reduce duration (try 20–30 minutes) and loop it.
      </div>
    </div>
  </div>

<script>
/* PWA offline */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
}

/* 12 diesel boat engine “models” (procedural presets) */
const PRESETS = [
  { id:"workboat_i4", name:"Workboat I4 (tight exhaust)", cyl:4, formA:120, formB:360, formQ:8.5, muffle:0.62, rough:0.30, thump:0.38, ring:0.22, ringHz:96,  turboFreq:850,  turboSpool:0.18, turboHiss:0.22 },
  { id:"harbor_i6",   name:"Harbor I6 (smooth low drone)", cyl:6, formA:95,  formB:280, formQ:7.0, muffle:0.70, rough:0.18, thump:0.30, ring:0.15, ringHz:86,  turboFreq:720,  turboSpool:0.10, turboHiss:0.18 },
  { id:"trawler_i6",  name:"Trawler I6 (deep stack)",      cyl:6, formA:140, formB:420, formQ:6.5, muffle:0.52, rough:0.32, thump:0.55, ring:0.28, ringHz:92,  turboFreq:980,  turboSpool:0.14, turboHiss:0.25 },
  { id:"ferry_v8",    name:"Ferry V8 (big pulse)",         cyl:8, formA:110, formB:330, formQ:6.2, muffle:0.58, rough:0.28, thump:0.62, ring:0.32, ringHz:78,  turboFreq:1050, turboSpool:0.16, turboHiss:0.24 },
  { id:"sport_v6",    name:"Sport V6 (brighter exhaust)",  cyl:6, formA:170, formB:620, formQ:8.0, muffle:0.42, rough:0.26, thump:0.40, ring:0.20, ringHz:112, turboFreq:1300, turboSpool:0.22, turboHiss:0.32 },
  { id:"tug_v12",     name:"Tug V12 (heavy rumble)",       cyl:12,formA:85,  formB:250, formQ:5.8, muffle:0.72, rough:0.22, thump:0.70, ring:0.35, ringHz:64,  turboFreq:800,  turboSpool:0.12, turboHiss:0.16 },
  { id:"gen_set_i3",  name:"Small Gen-Set I3 (chattery)",  cyl:3, formA:210, formB:720, formQ:10.0,muffle:0.35, rough:0.55, thump:0.33, ring:0.18, ringHz:128, turboFreq:1500, turboSpool:0.28, turboHiss:0.40 },
  { id:"old_i6",      name:"Older I6 (lopey, warm)",       cyl:6, formA:125, formB:390, formQ:7.8, muffle:0.60, rough:0.45, thump:0.58, ring:0.26, ringHz:90,  turboFreq:900,  turboSpool:0.15, turboHiss:0.22 },
  { id:"modern_i6",   name:"Modern I6 (cleaner tone)",     cyl:6, formA:150, formB:480, formQ:9.2, muffle:0.50, rough:0.20, thump:0.40, ring:0.22, ringHz:102, turboFreq:1200, turboSpool:0.20, turboHiss:0.28 },
  { id:"cargo_v8",    name:"Cargo V8 (stack resonance)",   cyl:8, formA:105, formB:290, formQ:5.6, muffle:0.66, rough:0.24, thump:0.64, ring:0.34, ringHz:72,  turboFreq:780,  turboSpool:0.12, turboHiss:0.18 },
  { id:"fast_i4",     name:"Fast I4 (higher whine)",       cyl:4, formA:190, formB:700, formQ:9.5, muffle:0.40, rough:0.25, thump:0.36, ring:0.16, ringHz:118, turboFreq:1600, turboSpool:0.30, turboHiss:0.38 },
  { id:"patrol_v10",  name:"Patrol V10 (wide exhaust)",    cyl:10,formA:115, formB:360, formQ:6.8, muffle:0.54, rough:0.26, thump:0.66, ring:0.30, ringHz:80,  turboFreq:980,  turboSpool:0.16, turboHiss:0.22 },
];

const $ = (id) => document.getElementById(id);
const statusEl = $("status");

function setStatus(msg){ statusEl.textContent = msg; }
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

function readParams(){
  const preset = $("preset").value;
  const found = PRESETS.find(p => p.id === preset);
  return {
    // engine identity
    cyl: found?.cyl ?? 6,

    // UI params
    hq: +$("hq").value,
    master: +$("master").value,
    stereo: +$("stereo").value,
    limiter: +$("limiter").value,

    engine: +$("engine").value,
    exhaust: +$("exhaust").value,
    turbo: +$("turbo").value,
    waves: +$("waves").value,
    current: +$("current").value,

    rpm: +$("rpm").value,
    load: +$("load").value,
    rough: +$("rough").value,
    thump: +$("thump").value,

    muffle: +$("muffle").value,
    formA: +$("formA").value,
    formB: +$("formB").value,
    formQ: +$("formQ").value,
    ring: +$("ring").value,
    ringHz: +$("ringHz").value,

    turboFreq: +$("turboFreq").value,
    turboSpool: +$("turboSpool").value,
    turboHiss: +$("turboHiss").value,
    flutter: +$("flutter").value,

    chop: +$("chop").value,
    bright: +$("bright").value,
  };
}

function updateLabels(){
  const p = readParams();
  const map = {
    masterV:p.master, stereoV:p.stereo, limiterV:p.limiter,
    engineV:p.engine, exhaustV:p.exhaust, turboV:p.turbo, wavesV:p.waves, currentV:p.current,
    rpmV:Math.round(p.rpm), loadV:p.load, roughV:p.rough, thumpV:p.thump,
    muffleV:p.muffle, formAV:Math.round(p.formA), formBV:Math.round(p.formB), formQV:p.formQ,
    ringV:p.ring, ringHzV:Math.round(p.ringHz),
    turboFreqV:Math.round(p.turboFreq), turboSpoolV:p.turboSpool, turboHissV:p.turboHiss, flutterV:p.flutter,
    chopV:p.chop, brightV:p.bright,
  };
  for (const [k,v] of Object.entries(map)){
    $(k).textContent = (typeof v === "number") ? (Number.isInteger(v) ? String(v) : v.toFixed(2)) : String(v);
  }
}

function applyPreset(p){
  $("formA").value = p.formA;
  $("formB").value = p.formB;
  $("formQ").value = p.formQ;
  $("muffle").value = p.muffle;
  $("rough").value = p.rough;
  $("thump").value = p.thump;
  $("ring").value = p.ring;
  $("ringHz").value = p.ringHz;
  $("turboFreq").value = p.turboFreq;
  $("turboSpool").value = p.turboSpool;
  $("turboHiss").value = p.turboHiss;

  // sensible mix defaults
  $("engine").value  = "0.24";
  $("exhaust").value = String(clamp(0.18 + 0.55*p.thump, 0, 1));
  $("turbo").value   = "0.14";
  updateLabels();
  pushParams();
}

/* Streaming AudioWorklet */
let audioCtx = null;
let node = null;

function buildWorkletCode(){
  return `
  class OnePole {
    constructor(){ this.y=0; this.a=0.01; }
    setCutoff(hz, sr){
      const a = 1 - Math.exp(-2*Math.PI*hz/sr);
      this.a = Math.min(0.999999, Math.max(0.000001, a));
    }
    lp(x){ this.y += this.a*(x - this.y); return this.y; }
  }
  class BiquadBP {
    constructor(){ this.b0=0;this.b1=0;this.b2=0;this.a1=0;this.a2=0;this.z1=0;this.z2=0; }
    set(centerHz, Q, sr){
      const hz = Math.max(10, Math.min(centerHz, 0.49*sr));
      Q = Math.max(0.5, Math.min(Q, 40));
      const w0 = 2*Math.PI*hz/sr;
      const cosw0 = Math.cos(w0), sinw0 = Math.sin(w0);
      const alpha = sinw0/(2*Q);
      const a0 = 1 + alpha;
      this.b0 = ( alpha)/a0;
      this.b1 = 0.0;
      this.b2 = (-alpha)/a0;
      this.a1 = (-2*cosw0)/a0;
      this.a2 = (1 - alpha)/a0;
    }
    process(x){
      const y = this.b0*x + this.z1;
      this.z1 = this.b1*x - this.a1*y + this.z2;
      this.z2 = this.b2*x - this.a2*y;
      return y;
    }
  }
  class XorShift {
    constructor(seed){ this.x = seed >>> 0 || 0x12345678; }
    next(){
      let x = this.x;
      x ^= x << 13; x >>>= 0;
      x ^= x >> 17; x >>>= 0;
      x ^= x << 5;  x >>>= 0;
      this.x = x;
      return x;
    }
    white(){ return ((this.next() / 4294967295) * 2) - 1; } // [-1,1]
  }
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function softclip(x){ return Math.tanh(x); }
  function fract(x){ return x - Math.floor(x); }

  class Comb {
    constructor(sr){
      this.sr = sr;
      this.len = Math.max(1, Math.floor(sr / 90));
      this.buf = new Float32Array(this.len);
      this.idx = 0;
      this.fb = 0.35;
    }
    set(hz, fb){
      const l = Math.max(1, Math.floor(this.sr / Math.max(20, hz)));
      if (l !== this.len){
        this.len = l;
        this.buf = new Float32Array(this.len);
        this.idx = 0;
      }
      this.fb = clamp(fb, 0, 0.85);
    }
    process(x){
      const y = this.buf[this.idx];
      const out = y;
      this.buf[this.idx] = x + y * this.fb;
      this.idx++; if (this.idx >= this.len) this.idx = 0;
      return out;
    }
  }

  class BoatNoiseProcessor extends AudioWorkletProcessor {
    constructor(){
      super();
      this.sr = sampleRate;
      this.rng = new XorShift((Date.now() ^ 0x9E3779B9) >>> 0);

      this.p = {
        hq: 0,
        cyl: 6,
        master: 0.55,
        stereo: 0.60,
        limiter: 0.65,
        engine: 0.25,
        exhaust: 0.35,
        turbo: 0.15,
        waves: 0.20,
        current: 0.20,
        rpm: 780,
        load: 0.35,
        rough: 0.35,
        thump: 0.45,
        muffle: 0.55,
        formA: 140,
        formB: 420,
        formQ: 7.0,
        ring: 0.25,
        ringHz: 92,
        turboFreq: 950,
        turboSpool: 0.15,
        turboHiss: 0.25,
        flutter: 0.10,
        chop: 0.07,
        bright: 0.35
      };

      // phases
      this.ph1=0; this.ph2=0; this.ph3=0;
      this.phFire=0;
      this.phWave=0;
      this.phSpool=0;
      this.phPan=0;
      this.phTone=0;

      // filters
      this.engLP = new OnePole(); this.engLP.setCutoff(180, this.sr);
      this.engHP = new OnePole(); this.engHP.setCutoff(18, this.sr);
      this.roughLP = new OnePole(); this.roughLP.setCutoff(2.5, this.sr);

      this.waveLP = new OnePole(); this.waveLP.setCutoff(1200, this.sr);
      this.waveHP = new OnePole(); this.waveHP.setCutoff(40, this.sr);
      this.waveEnvLP = new OnePole(); this.waveEnvLP.setCutoff(0.25, this.sr);

      this.currLP = new OnePole(); this.currLP.setCutoff(2000, this.sr);
      this.currHP = new OnePole(); this.currHP.setCutoff(120, this.sr);

      this.turboHP = new OnePole(); this.turboHP.setCutoff(120, this.sr);
      this.exhMuffleLP = new OnePole(); this.exhMuffleLP.setCutoff(600, this.sr);

      this.form1 = new BiquadBP(); this.form1.set(this.p.formA, this.p.formQ, this.sr);
      this.form2 = new BiquadBP(); this.form2.set(this.p.formB, this.p.formQ, this.sr);
      this.turboBP = new BiquadBP(); this.turboBP.set(this.p.turboFreq, 7.0, this.sr);

      // HQ stack ring (comb + extra BP)
      this.stackComb = new Comb(this.sr);
      this.stackBP = new BiquadBP(); this.stackBP.set(120, 5.0, this.sr);

      this.port.onmessage = (ev) => {
        const m = ev.data || {};
        if (m.type === "params" && m.params) {
          Object.assign(this.p, m.params);
          this.form1.set(this.p.formA, this.p.formQ, this.sr);
          this.form2.set(this.p.formB, this.p.formQ, this.sr);
        }
      };
    }

    process(_, outputs){
      const out = outputs[0];
      const L = out[0];
      const R = out[1] || out[0];
      const p = this.p;
      const sr = this.sr;

      const baseHz = p.rpm / 60.0;
      const fireHz = baseHz * (p.cyl / 2); // 4-stroke approximation
      const stereoAmt = p.stereo;

      for (let i=0; i<L.length; i++){
        // roughness (slow rpm wobble)
        const r = this.rng.white();
        const rough = this.roughLP.lp(r);
        const rpmMod = 1.0 + p.rough * 0.015 * rough;
        const hz = baseHz * rpmMod;

        // engine bed
        this.ph1 = fract(this.ph1 + hz / sr);
        this.ph2 = fract(this.ph2 + (2*hz) / sr);
        this.ph3 = fract(this.ph3 + (3*hz) / sr);

        let engineBed =
          0.55*Math.sin(2*Math.PI*this.ph1) +
          0.25*Math.sin(2*Math.PI*this.ph2) +
          0.15*Math.sin(2*Math.PI*this.ph3);

        // mechanical texture
        const mech = this.engLP.lp(this.rng.white());
        engineBed += 0.18*p.rough*mech;

        // HP (x - LP)
        const engine = softclip((engineBed - this.engHP.lp(engineBed)) * 1.15);

        // firing pulses (exhaust excitation)
        this.phFire = fract(this.phFire + (fireHz * (0.9 + 0.2*p.load)) / sr);
        let pulse = 0;
        const w = 0.02 + 0.05*p.thump;
        if (this.phFire < w){
          const x = this.phFire / w;
          pulse = Math.exp(-10*x) * (1 - x);
        }

        // exhaust excitation: pulse + load rasp noise
        let exhExcite = (1.25*pulse) + (0.25 + 0.45*p.load)*(0.25*this.rng.white());

        // main exhaust formants
        let exh = 0.85*this.form1.process(exhExcite) + 0.65*this.form2.process(exhExcite);

        // muffling (LP)
        const muffHz = 300 + (1 - p.muffle)*2200;
        this.exhMuffleLP.setCutoff(muffHz, sr);
        exh = this.exhMuffleLP.lp(exh);

        // HQ stack ring/comb + extra resonance
        if (p.hq > 0.5) {
          this.stackComb.set(p.ringHz, 0.10 + 0.70*p.ring);
          const ring = this.stackComb.process(exh) * (0.25 + 0.85*p.ring);
          this.stackBP.set(p.ringHz * 1.35, 5.0 + 8.0*p.ring, sr);
          exh = exh + 0.55*this.stackBP.process(ring);
        }

        // saturation for “stack body”
        exh = softclip(exh * (1.1 + 0.7*p.load));

        // turbo spool
        this.phSpool = fract(this.phSpool + (0.08 + 0.28*p.turboSpool*(0.5 + p.load)) / sr);
        const spoolL = 0.5*(Math.sin(2*Math.PI*this.phSpool) + 1); // 0..1
        const turboCenter = p.turboFreq * (0.80 + 0.35*spoolL + 0.25*p.load);

        // turbo hiss bandpass
        this.turboBP.set(turboCenter, 7.0, sr);
        const hiss = this.turboBP.process(this.rng.white()) * (0.35 + 0.75*p.turboHiss);

        // turbo tone
        this.phTone = fract(this.phTone + (turboCenter*(0.95 + 0.04*Math.sin(2*Math.PI*this.phSpool))) / sr);
        const tone = Math.sin(2*Math.PI*this.phTone);

        // flutter (AM bursts)
        const flutterRate = 18 + 28*p.load;
        this.phPan = fract(this.phPan + 0.03/sr);
        const flutterMod = 0.5*(Math.sin(2*Math.PI*fract(this.phPan + flutterRate/sr)) + 1);
        const flutterAmt = p.flutter * p.load;
        const flutterGate = (flutterMod > (0.55 - 0.20*p.load)) ? 1.0 : 0.35;

        let turbo = 0.70*(0.75*hiss + 0.25*tone);
        turbo *= (1 - flutterAmt) + flutterAmt*flutterGate;

        // HP + saturate
        turbo = turbo - this.turboHP.lp(turbo);
        turbo = softclip(turbo * (0.85 + 0.60*spoolL));

        // waves
        this.phWave = fract(this.phWave + p.chop / sr);
        const waveLFO = 0.5*(Math.sin(2*Math.PI*this.phWave) + 1);
        const waveRand = 0.5*(this.rng.white() + 1);
        const waveEnv = this.waveEnvLP.lp(0.65*waveLFO + 0.35*waveRand);

        let waveN = this.rng.white();
        waveN = this.waveLP.lp(waveN);
        const waveHP = this.waveHP.lp(waveN);
        waveN = waveN - waveHP;
        const waves = softclip(waveN * (0.65 + 1.0*waveEnv));

        // current
        const cutoff = 900 + p.bright*5200;
        this.currLP.setCutoff(cutoff, sr);
        let currN = this.rng.white();
        const currBody = this.currLP.lp(currN);
        const currHiss = currN - this.currHP.lp(currN);
        let current = 0.75*currBody + (0.25 + 0.45*p.bright)*currHiss;
        current = softclip(current * 0.8);

        // mix
        let mix =
          p.engine  * engine +
          p.exhaust * exh +
          p.turbo   * turbo +
          p.waves   * waves +
          p.current * current;

        // limiter
        const lim = clamp(p.limiter, 0, 1);
        mix = softclip(mix * (1.0 + 1.8*lim)) / (1.0 + 0.9*lim);

        // master
        mix *= p.master;

        // stereo
        let l = mix, rch = mix;
        if (out.length > 1){
          const pan = clamp(0.35*stereoAmt*Math.sin(2*Math.PI*this.phPan) + 0.15*stereoAmt*this.rng.white(), -1, 1);
          const lg = Math.sqrt(0.5*(1 - pan));
          const rg = Math.sqrt(0.5*(1 + pan));
          const decor = 0.02*stereoAmt*waveN;
          l = softclip(l*lg + decor);
          rch = softclip(rch*rg - decor);
        }

        L[i] = l;
        if (out.length > 1) R[i] = rch;
      }
      return true;
    }
  }

  registerProcessor("boat-noise", BoatNoiseProcessor);
  `;
}

async function ensureAudio(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: "playback" });

  if (!audioCtx.audioWorklet) {
    throw new Error("AudioWorklet not available. Use Safari/Chrome on iOS and open the app via GitHub Pages (HTTPS).");
  }

  const code = buildWorkletCode();
  const blob = new Blob([code], { type:"application/javascript" });
  const url = URL.createObjectURL(blob);
  await audioCtx.audioWorklet.addModule(url);
  URL.revokeObjectURL(url);

  node = new AudioWorkletNode(audioCtx, "boat-noise", { numberOfOutputs: 1, outputChannelCount: [2] });
  node.connect(audioCtx.destination);
  pushParams();
}

function pushParams(){
  if (!node) return;
  node.port.postMessage({ type:"params", params: readParams() });
}

/* WAV export: safe chunk generation and download (keep duration moderate on iPhone) */
function encodeWavHeader({sampleRate, numChannels, numFrames}){
  const bytesPerSample = 2;
  const blockAlign = numChannels * bytesPerSample;
  const byteRate = sampleRate * blockAlign;
  const dataSize = numFrames * blockAlign;
  const buffer = new ArrayBuffer(44);
  const view = new DataView(buffer);
  const wstr = (off, s)=>{ for (let i=0;i<s.length;i++) view.setUint8(off+i, s.charCodeAt(i)); };
  wstr(0, "RIFF"); view.setUint32(4, 36 + dataSize, true); wstr(8, "WAVE");
  wstr(12, "fmt "); view.setUint32(16, 16, true); view.setUint16(20, 1, true);
  view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true);
  view.setUint32(28, byteRate, true); view.setUint16(32, blockAlign, true); view.setUint16(34, 16, true);
  wstr(36, "data"); view.setUint32(40, dataSize, true);
  return new Uint8Array(buffer);
}
function floatToPCM16(x){
  x = Math.max(-1, Math.min(1, x));
  const v = Math.round(x * 32767);
  return Math.max(-32767, Math.min(32767, v));
}

function makeExportGenerator(sampleRate, channels, params){
  // Minimal JS generator matching the worklet’s sound.
  class OnePole { constructor(){ this.y=0; this.a=0.01; } setCutoff(hz){ const a=1-Math.exp(-2*Math.PI*hz/sampleRate); this.a=Math.min(0.999999,Math.max(0.000001,a)); } lp(x){ this.y += this.a*(x-this.y); return this.y; } }
  class BiquadBP {
    constructor(){ this.b0=0;this.b1=0;this.b2=0;this.a1=0;this.a2=0;this.z1=0;this.z2=0; }
    set(centerHz, Q){
      const hz = Math.max(10, Math.min(centerHz, 0.49*sampleRate));
      Q = Math.max(0.5, Math.min(Q, 40));
      const w0 = 2*Math.PI*hz/sampleRate;
      const cosw0 = Math.cos(w0), sinw0 = Math.sin(w0);
      const alpha = sinw0/(2*Q);
      const a0 = 1 + alpha;
      this.b0 = ( alpha)/a0; this.b1 = 0.0; this.b2 = (-alpha)/a0;
      this.a1 = (-2*cosw0)/a0; this.a2 = (1 - alpha)/a0;
    }
    process(x){
      const y = this.b0*x + this.z1;
      this.z1 = this.b1*x - this.a1*y + this.z2;
      this.z2 = this.b2*x - this.a2*y;
      return y;
    }
  }
  class Comb {
    constructor(sr){ this.sr=sr; this.len=Math.max(1, Math.floor(sr/90)); this.buf=new Float32Array(this.len); this.idx=0; this.fb=0.35; }
    set(hz, fb){
      const l=Math.max(1, Math.floor(this.sr/Math.max(20,hz)));
      if (l!==this.len){ this.len=l; this.buf=new Float32Array(this.len); this.idx=0; }
      this.fb=Math.max(0, Math.min(0.85, fb));
    }
    process(x){
      const y=this.buf[this.idx];
      this.buf[this.idx]=x + y*this.fb;
      this.idx++; if (this.idx>=this.len) this.idx=0;
      return y;
    }
  }
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const softclip = (x)=>Math.tanh(x);
  const fract = (x)=>x - Math.floor(x);

  let xs = ((Date.now() ^ 0x9E3779B9) >>> 0) || 0x12345678;
  function white(){
    xs ^= (xs << 13) >>> 0;
    xs ^= (xs >>> 17) >>> 0;
    xs ^= (xs << 5) >>> 0;
    return ((xs / 4294967295) * 2) - 1;
  }

  const p = { ...params };
  const engLP=new OnePole(); engLP.setCutoff(180);
  const engHP=new OnePole(); engHP.setCutoff(18);
  const roughLP=new OnePole(); roughLP.setCutoff(2.5);

  const waveLP=new OnePole(); waveLP.setCutoff(1200);
  const waveHP=new OnePole(); waveHP.setCutoff(40);
  const waveEnvLP=new OnePole(); waveEnvLP.setCutoff(0.25);

  const currLP=new OnePole(); currLP.setCutoff(2000);
  const currHP=new OnePole(); currHP.setCutoff(120);

  const turboHP=new OnePole(); turboHP.setCutoff(120);
  const exhMuffleLP=new OnePole(); exhMuffleLP.setCutoff(600);

  const form1=new BiquadBP(); form1.set(p.formA, p.formQ);
  const form2=new BiquadBP(); form2.set(p.formB, p.formQ);
  const turboBP=new BiquadBP(); turboBP.set(p.turboFreq, 7.0);

  const comb=new Comb(sampleRate);
  const stackBP=new BiquadBP(); stackBP.set(120, 5.0);

  let ph1=0,ph2=0,ph3=0,phFire=0,phWave=0,phSpool=0,phPan=0,phTone=0;

  return {
    nextFrame(){
      const baseHz = p.rpm / 60.0;
      const fireHz = baseHz * (p.cyl / 2);

      const rough = roughLP.lp(white());
      const rpmMod = 1.0 + p.rough * 0.015 * rough;
      const hz = baseHz * rpmMod;

      ph1 = fract(ph1 + hz/sampleRate);
      ph2 = fract(ph2 + (2*hz)/sampleRate);
      ph3 = fract(ph3 + (3*hz)/sampleRate);

      let engineBed =
        0.55*Math.sin(2*Math.PI*ph1) +
        0.25*Math.sin(2*Math.PI*ph2) +
        0.15*Math.sin(2*Math.PI*ph3);

      const mech = engLP.lp(white());
      engineBed += 0.18*p.rough*mech;
      const engine = softclip((engineBed - engHP.lp(engineBed)) * 1.15);

      phFire = fract(phFire + (fireHz*(0.9+0.2*p.load))/sampleRate);
      let pulse=0;
      const w = 0.02 + 0.05*p.thump;
      if (phFire < w){
        const x=phFire/w;
        pulse = Math.exp(-10*x) * (1-x);
      }

      let exhExcite = (1.25*pulse) + (0.25 + 0.45*p.load)*(0.25*white());
      let exh = 0.85*form1.process(exhExcite) + 0.65*form2.process(exhExcite);

      const muffHz = 300 + (1 - p.muffle)*2200;
      exhMuffleLP.setCutoff(muffHz);
      exh = exhMuffleLP.lp(exh);

      if (p.hq > 0.5) {
        comb.set(p.ringHz, 0.10 + 0.70*p.ring);
        const ring = comb.process(exh) * (0.25 + 0.85*p.ring);
        stackBP.set(p.ringHz * 1.35, 5.0 + 8.0*p.ring);
        exh = exh + 0.55*stackBP.process(ring);
      }

      exh = softclip(exh * (1.1 + 0.7*p.load));

      phSpool = fract(phSpool + (0.08 + 0.28*p.turboSpool*(0.5+p.load))/sampleRate);
      const spoolL = 0.5*(Math.sin(2*Math.PI*phSpool)+1);
      const turboCenter = p.turboFreq * (0.80 + 0.35*spoolL + 0.25*p.load);

      turboBP.set(turboCenter, 7.0);
      const hiss = turboBP.process(white()) * (0.35 + 0.75*p.turboHiss);

      phTone = fract(phTone + (turboCenter*(0.95 + 0.04*Math.sin(2*Math.PI*phSpool)))/sampleRate);
      const tone = Math.sin(2*Math.PI*phTone);

      const flutterRate = 18 + 28*p.load;
      phPan = fract(phPan + 0.03/sampleRate);
      const flutterMod = 0.5*(Math.sin(2*Math.PI*fract(phPan + flutterRate/sampleRate))+1);
      const flutterAmt = p.flutter * p.load;
      const flutterGate = (flutterMod > (0.55 - 0.20*p.load)) ? 1.0 : 0.35;

      let turbo = 0.70*(0.75*hiss + 0.25*tone);
      turbo *= (1 - flutterAmt) + flutterAmt*flutterGate;
      turbo = turbo - turboHP.lp(turbo);
      turbo = softclip(turbo * (0.85 + 0.60*spoolL));

      phWave = fract(phWave + p.chop/sampleRate);
      const waveLFO = 0.5*(Math.sin(2*Math.PI*phWave)+1);
      const waveRand = 0.5*(white()+1);
      const waveEnv = waveEnvLP.lp(0.65*waveLFO + 0.35*waveRand);

      let waveN = white();
      waveN = waveLP.lp(waveN);
      const waveHPv = waveHP.lp(waveN);
      waveN = waveN - waveHPv;
      const waves = softclip(waveN * (0.65 + 1.0*waveEnv));

      const cutoff = 900 + p.bright*5200;
      currLP.setCutoff(cutoff);
      let currN = white();
      const currBody = currLP.lp(currN);
      const currHiss = currN - currHP.lp(currN);
      let current = 0.75*currBody + (0.25 + 0.45*p.bright)*currHiss;
      current = softclip(current * 0.8);

      let mix =
        p.engine*engine + p.exhaust*exh + p.turbo*turbo + p.waves*waves + p.current*current;

      const lim = clamp(p.limiter, 0, 1);
      mix = softclip(mix * (1.0 + 1.8*lim)) / (1.0 + 0.9*lim);
      mix *= p.master;

      let l=mix, rch=mix;
      if (channels === 2){
        const pan = clamp(0.35*p.stereo*Math.sin(2*Math.PI*phPan) + 0.15*p.stereo*white(), -1, 1);
        const lg = Math.sqrt(0.5*(1 - pan));
        const rg = Math.sqrt(0.5*(1 + pan));
        const decor = 0.02*p.stereo*waveN;
        l = softclip(l*lg + decor);
        rch = softclip(rch*rg - decor);
      }
      return [l, rch];
    }
  };
}

async function exportWav(){
  const minutes = +$("minutes").value;
  const sampleRate = +$("sr").value;
  const channels = +$("ch").value;
  const filename = ($("filename").value || "diesel_boat_sleep.wav").trim();

  if (!Number.isFinite(minutes) || minutes <= 0) throw new Error("Invalid duration.");
  if (minutes > 240) {
    if (!confirm("Long exports may fail on iPhone. Prefer 20–60 minutes and loop. Continue anyway?")) return;
  }

  setStatus("Export: preparing...");
  const p = readParams();
  const gen = makeExportGenerator(sampleRate, channels, p);

  const totalFrames = Math.floor(minutes * 60 * sampleRate);
  const chunkFrames = 8192;
  const parts = [encodeWavHeader({ sampleRate, numChannels: channels, numFrames: totalFrames })];

  let done = 0;
  while (done < totalFrames){
    const n = Math.min(chunkFrames, totalFrames - done);
    const pcm = new Int16Array(n * channels);

    for (let i=0;i<n;i++){
      const [l, r] = gen.nextFrame();
      pcm[i*channels + 0] = floatToPCM16(l);
      if (channels === 2) pcm[i*channels + 1] = floatToPCM16(r);
    }

    parts.push(new Uint8Array(pcm.buffer));
    done += n;

    if (done % Math.floor(sampleRate * 0.5) < chunkFrames){
      setStatus(`Export: ${Math.floor((done/totalFrames)*100)}%`);
      await new Promise(r => setTimeout(r, 0));
    }
  }

  setStatus("Export: downloading...");
  const blob = new Blob(parts, { type: "audio/wav" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = filename.endsWith(".wav") ? filename : (filename + ".wav");
  document.body.appendChild(a);
  a.click();
  a.remove();

  setTimeout(() => URL.revokeObjectURL(url), 15000);
  setStatus("Export complete. Check Downloads/Files.");
}

/* UI wiring */
function initPresets(){
  const sel = $("preset");
  sel.innerHTML = "";
  for (const p of PRESETS){
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = p.name;
    sel.appendChild(opt);
  }
  sel.value = "trawler_i6";
  applyPreset(PRESETS.find(p=>p.id==="trawler_i6"));
}
function bind(){
  const ids = ["hq","master","stereo","limiter","engine","exhaust","turbo","waves","current","rpm","load","rough","thump","muffle","formA","formB","formQ","ring","ringHz","turboFreq","turboSpool","turboHiss","flutter","chop","bright"];
  ids.forEach(id => $(id).addEventListener("input", ()=>{ updateLabels(); pushParams(); }));
  $("preset").addEventListener("change", ()=>{
    const p = PRESETS.find(x=>x.id === $("preset").value);
    if (p) applyPreset(p);
  });

  $("btnStart").addEventListener("click", async ()=>{
    try {
      await ensureAudio();
      if (audioCtx.state !== "running") await audioCtx.resume();
      $("btnStart").disabled = true;
      $("btnStop").disabled = false;
      setStatus("Running (streaming).");
    } catch(e){
      setStatus("Start failed.");
      alert(e?.message || String(e));
    }
  });
  $("btnStop").addEventListener("click", async ()=>{
    if (audioCtx) await audioCtx.suspend();
    $("btnStart").disabled = false;
    $("btnStop").disabled = true;
    setStatus("Stopped.");
  });
  $("btnExport").addEventListener("click", async ()=>{
    try {
      $("btnExport").disabled = true;
      await exportWav();
    } catch(e){
      alert(e?.message || String(e));
      setStatus("Export failed.");
    } finally {
      $("btnExport").disabled = false;
    }
  });
}

initPresets();
updateLabels();
bind();
setStatus("Ready. Tap Start to unlock audio.");
</script>
</body>
</html>