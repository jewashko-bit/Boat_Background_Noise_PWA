<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0c10" />
  <link rel="manifest" href="manifest.webmanifest" />
  <title>Boat Background Noise PWA</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#0b0c10; }
    body { margin: 16px; max-width: 900px; }
    h1 { margin:0 0 6px; font-size: 20px; }
    .sub { color:#444; font-size: 12.5px; line-height:1.35; margin-bottom: 12px; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 10px 0 14px; }
    button { padding:10px 12px; border-radius:12px; border:1px solid #bbb; background:#f7f7f7; font-weight:650; }
    button.primary { background:#0b0c10; color:#fff; border-color:#0b0c10; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; background:#fff; margin-bottom: 12px; }
    .row { display:grid; grid-template-columns: 180px 1fr 90px; gap:10px; align-items:center; margin: 10px 0; }
    label { font-size: 13px; }
    input[type="range"] { width: 100%; }
    select { width:100%; padding:7px 8px; border:1px solid #ccc; border-radius:10px; font-size: 13px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .status { font-size: 13px; }
    .warn { color:#8a2a2a; font-size: 12.5px; line-height: 1.35; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>Boat Noise PWA (Streaming)</h1>
  <div class="sub">
    If there’s no sound: press <b>Test Tone</b>. If tone works but engine doesn’t, the worklet didn’t load.
    Use the status line to see exactly where it fails.
  </div>

  <div class="actions">
    <button id="btnStart" class="primary">Start</button>
    <button id="btnStop" disabled>Stop</button>
    <button id="btnTest">Test Tone</button>
    <button id="btnReset">Reset Cache</button>
    <span id="status" class="status">Ready.</span>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">Engine Preset</h3>
    <div class="row">
      <label>Preset</label>
      <select id="preset"></select>
      <span></span>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">Mix</h3>
    <div class="row"><label>Master</label><input id="master" type="range" min="0" max="1" step="0.01" value="0.7"><span id="masterV" class="mono"></span></div>
    <div class="row"><label>Engine</label><input id="engine" type="range" min="0" max="1" step="0.01" value="0.35"><span id="engineV" class="mono"></span></div>
    <div class="row"><label>Exhaust</label><input id="exhaust" type="range" min="0" max="1" step="0.01" value="0.55"><span id="exhaustV" class="mono"></span></div>
    <div class="row"><label>Turbo</label><input id="turbo" type="range" min="0" max="1" step="0.01" value="0.20"><span id="turboV" class="mono"></span></div>
    <div class="row"><label>Waves</label><input id="waves" type="range" min="0" max="1" step="0.01" value="0.10"><span id="wavesV" class="mono"></span></div>
    <div class="row"><label>Current</label><input id="current" type="range" min="0" max="1" step="0.01" value="0.10"><span id="currentV" class="mono"></span></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">Tone</h3>
    <div class="row"><label>RPM</label><input id="rpm" type="range" min="300" max="2200" step="10" value="800"><span id="rpmV" class="mono"></span></div>
    <div class="row"><label>Load</label><input id="load" type="range" min="0" max="1" step="0.01" value="0.50"><span id="loadV" class="mono"></span></div>
    <div class="row"><label>Roughness</label><input id="rough" type="range" min="0" max="1" step="0.01" value="0.35"><span id="roughV" class="mono"></span></div>
    <div class="row"><label>Turbo Base Freq</label><input id="turboFreq" type="range" min="200" max="4200" step="10" value="1200"><span id="turboFreqV" class="mono"></span></div>
    <div class="row"><label>Turbo Spool</label><input id="turboSpool" type="range" min="0" max="1" step="0.01" value="0.20"><span id="turboSpoolV" class="mono"></span></div>
  </div>

  <div class="warn">
    iOS requirements: open the <b>GitHub Pages URL in Safari</b> (not inside the GitHub app). Turn Silent mode off and press Start once.
  </div>

<script>
  // Register SW (safe even if it fails)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
  }

  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");
  const setStatus = (s) => statusEl.textContent = s;

  // 12 presets
  const PRESETS = [
    { id:"workboat_i4", name:"Workboat I4", cyl:4, turboFreq:900 },
    { id:"harbor_i6",   name:"Harbor I6",   cyl:6, turboFreq:750 },
    { id:"trawler_i6",  name:"Trawler I6",  cyl:6, turboFreq:1100 },
    { id:"ferry_v8",    name:"Ferry V8",    cyl:8, turboFreq:1050 },
    { id:"sport_v6",    name:"Sport V6",    cyl:6, turboFreq:1500 },
    { id:"tug_v12",     name:"Tug V12",     cyl:12,turboFreq:850 },
    { id:"gen_set_i3",  name:"Gen-Set I3",  cyl:3, turboFreq:1700 },
    { id:"old_i6",      name:"Older I6",    cyl:6, turboFreq:950 },
    { id:"modern_i6",   name:"Modern I6",   cyl:6, turboFreq:1300 },
    { id:"cargo_v8",    name:"Cargo V8",    cyl:8, turboFreq:820 },
    { id:"fast_i4",     name:"Fast I4",     cyl:4, turboFreq:1800 },
    { id:"patrol_v10",  name:"Patrol V10",  cyl:10,turboFreq:1100 }
  ];

  function readParams(){
    const preset = PRESETS.find(p => p.id === $("preset").value) || PRESETS[0];
    return {
      cyl: preset.cyl,
      master: +$("master").value,
      engine: +$("engine").value,
      exhaust: +$("exhaust").value,
      turbo: +$("turbo").value,
      waves: +$("waves").value,
      current: +$("current").value,
      rpm: +$("rpm").value,
      load: +$("load").value,
      rough: +$("rough").value,
      turboFreq: +$("turboFreq").value,
      turboSpool: +$("turboSpool").value
    };
  }

  function safeSetText(id, txt){
    const el = $(id);
    if (el) el.textContent = txt;
  }

  function updateLabels(){
    const p = readParams();
    safeSetText("masterV", p.master.toFixed(2));
    safeSetText("engineV", p.engine.toFixed(2));
    safeSetText("exhaustV", p.exhaust.toFixed(2));
    safeSetText("turboV", p.turbo.toFixed(2));
    safeSetText("wavesV", p.waves.toFixed(2));
    safeSetText("currentV", p.current.toFixed(2));
    safeSetText("rpmV", String(Math.round(p.rpm)));
    safeSetText("loadV", p.load.toFixed(2));
    safeSetText("roughV", p.rough.toFixed(2));
    safeSetText("turboFreqV", String(Math.round(p.turboFreq)));
    safeSetText("turboSpoolV", p.turboSpool.toFixed(2));
  }

  // AudioWorklet
  let audioCtx = null;
  let node = null;

  function workletCode(){
    return `
      class OnePole { constructor(){ this.y=0; this.a=0.01; } setCutoff(hz, sr){ const a=1-Math.exp(-2*Math.PI*hz/sr); this.a=Math.min(0.999999,Math.max(0.000001,a)); } lp(x){ this.y += this.a*(x-this.y); return this.y; } }
      class XorShift { constructor(seed){ this.x=seed>>>0||0x12345678; } next(){ let x=this.x; x^=x<<13; x>>>=0; x^=x>>17; x>>>=0; x^=x<<5; x>>>=0; this.x=x; return x; } white(){ return ((this.next()/4294967295)*2)-1; } }
      function softclip(x){ return Math.tanh(x); }
      function fract(x){ return x - Math.floor(x); }

      class BoatProc extends AudioWorkletProcessor {
        constructor(){
          super();
          this.sr = sampleRate;
          this.rng = new XorShift((Date.now() ^ 0x9E3779B9) >>> 0);
          this.p = { cyl:6, master:0.7, engine:0.35, exhaust:0.55, turbo:0.2, waves:0.1, current:0.1, rpm:800, load:0.5, rough:0.35, turboFreq:1200, turboSpool:0.2 };
          this.ph1=0; this.ph2=0; this.ph3=0; this.phFire=0; this.phSpool=0; this.phTone=0; this.phWave=0;
          this.engHP = new OnePole(); this.engHP.setCutoff(18, this.sr);
          this.roughLP = new OnePole(); this.roughLP.setCutoff(2.5, this.sr);
          this.turboHP = new OnePole(); this.turboHP.setCutoff(120, this.sr);
          this.waveLP = new OnePole(); this.waveLP.setCutoff(1200, this.sr);
          this.waveHP = new OnePole(); this.waveHP.setCutoff(40, this.sr);
          this.waveEnv = new OnePole(); this.waveEnv.setCutoff(0.25, this.sr);
          this.port.onmessage = (ev)=>{ if(ev.data?.type==="params") Object.assign(this.p, ev.data.params); };
        }
        process(_, outputs){
          const out = outputs[0];
          const L = out[0];
          const R = out[1] || out[0];
          const p = this.p;
          const sr = this.sr;

          const baseHz = p.rpm/60;
          const fireHz = baseHz*(p.cyl/2);

          for(let i=0;i<L.length;i++){
            const rough = this.roughLP.lp(this.rng.white());
            const hz = baseHz*(1 + p.rough*0.015*rough);

            this.ph1 = fract(this.ph1 + hz/sr);
            this.ph2 = fract(this.ph2 + (2*hz)/sr);
            this.ph3 = fract(this.ph3 + (3*hz)/sr);

            let bed = 0.55*Math.sin(2*Math.PI*this.ph1) + 0.25*Math.sin(2*Math.PI*this.ph2) + 0.15*Math.sin(2*Math.PI*this.ph3);
            bed = bed - this.engHP.lp(bed);
            const engine = softclip(bed*1.2);

            this.phFire = fract(this.phFire + (fireHz*(0.9+0.2*p.load))/sr);
            const w = 0.02 + 0.05*p.load;
            let pulse = 0;
            if (this.phFire < w){
              const x = this.phFire/w;
              pulse = Math.exp(-10*x)*(1-x);
            }
            const exhaust = softclip((pulse + 0.15*this.rng.white())*(1.2 + 0.8*p.load));

            this.phSpool = fract(this.phSpool + (0.10 + 0.25*p.turboSpool*(0.5+p.load))/sr);
            const spool = 0.5*(Math.sin(2*Math.PI*this.phSpool)+1);
            const f = p.turboFreq*(0.85 + 0.35*spool + 0.25*p.load);
            this.phTone = fract(this.phTone + f/sr);
            let turbo = 0.25*Math.sin(2*Math.PI*this.phTone) + 0.35*this.rng.white();
            turbo = turbo - this.turboHP.lp(turbo);
            turbo = softclip(turbo*(0.65 + 0.55*spool));

            this.phWave = fract(this.phWave + 0.07/sr);
            const env = this.waveEnv.lp(0.6*(0.5*(Math.sin(2*Math.PI*this.phWave)+1)) + 0.4*(0.5*(this.rng.white()+1)));
            let waveN = this.rng.white();
            waveN = this.waveLP.lp(waveN);
            waveN = waveN - this.waveHP.lp(waveN);
            const waves = softclip(waveN*(0.6 + 0.9*env));

            const current = softclip(this.rng.white()*0.35);

            let mix =
              p.engine*engine +
              p.exhaust*exhaust +
              p.turbo*turbo +
              p.waves*waves +
              p.current*current;

            mix = softclip(mix*1.35) * p.master;
            L[i] = mix;
            if (out.length>1) R[i] = mix;
          }
          return true;
        }
      }
      registerProcessor("boat", BoatProc);
    `;
  }

  async function ensureAudio(){
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint:"playback" });

    if (!audioCtx.audioWorklet) throw new Error("AudioWorklet not available. Open the GitHub Pages URL in Safari (HTTPS).");

    const blob = new Blob([workletCode()], {type:"application/javascript"});
    const url = URL.createObjectURL(blob);

    setStatus("Loading worklet...");
    await audioCtx.audioWorklet.addModule(url);
    URL.revokeObjectURL(url);

    node = new AudioWorkletNode(audioCtx, "boat", { numberOfOutputs:1, outputChannelCount:[2] });
    node.connect(audioCtx.destination);

    setStatus("Worklet ready.");
    pushParams();
  }

  function pushParams(){
    if (!node) return;
    node.port.postMessage({ type:"params", params: readParams() });
  }

  // Buttons
  $("btnStart").addEventListener("click", async () => {
    try {
      await ensureAudio();
      setStatus("AudioContext: " + audioCtx.state);
      await audioCtx.resume();
      setStatus("Running. AudioContext: " + audioCtx.state);
      $("btnStart").disabled = true;
      $("btnStop").disabled = false;
    } catch (e) {
      alert(e?.message || String(e));
      setStatus("Start failed.");
    }
  });

  $("btnStop").addEventListener("click", async () => {
    if (audioCtx) await audioCtx.suspend();
    $("btnStart").disabled = false;
    $("btnStop").disabled = true;
    setStatus("Stopped. AudioContext: " + (audioCtx ? audioCtx.state : "n/a"));
  });

  $("btnTest").addEventListener("click", async () => {
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      await audioCtx.resume();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      g.gain.value = 0.06;
      o.frequency.value = 220;
      o.connect(g).connect(audioCtx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); o.disconnect(); g.disconnect(); }, 700);
      setStatus("Test tone played. AudioContext: " + audioCtx.state);
    } catch (e) {
      alert(e?.message || String(e));
      setStatus("Test tone failed.");
    }
  });

  $("btnReset").addEventListener("click", async () => {
    try {
      setStatus("Resetting cache...");
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (const r of regs) await r.unregister();
      }
      if (window.caches) {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      }
      setStatus("Reset done. Reloading...");
      location.reload();
    } catch {
      setStatus("Reset failed.");
    }
  });

  // Sliders: always update labels + params
  const sliderIds = ["master","engine","exhaust","turbo","waves","current","rpm","load","rough","turboFreq","turboSpool"];
  sliderIds.forEach(id => $(id).addEventListener("input", () => { updateLabels(); pushParams(); }));

  // Presets dropdown
  function initPresets(){
    const sel = $("preset");
    PRESETS.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id; opt.textContent = p.name;
      sel.appendChild(opt);
    });
    sel.value = "trawler_i6";
    const tr = PRESETS.find(p=>p.id==="trawler_i6");
    if (tr) $("turboFreq").value = String(tr.turboFreq);
  }
  $("preset").addEventListener("change", () => {
    const p = PRESETS.find(x => x.id === $("preset").value);
    if (p) $("turboFreq").value = String(p.turboFreq);
    updateLabels(); pushParams();
  });

  initPresets();
  updateLabels();
</script>
</body>
</html>